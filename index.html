<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üéÅ Roulette de No√´l ‚Äî Maxrob78</title>
<style>
:root {
  --bg: #0b1120;
  --accent: #7c3aed;
  --accent2: #06b6d4;
  --text: #e6eef5;
  --glass: rgba(255,255,255,0.05);
}
* { box-sizing: border-box; font-family: Inter, system-ui, sans-serif; }
body {
  margin: 0;
  background: radial-gradient(circle at 20% 20%, #0f172a, #020617 90%);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}
header { margin-top: 30px; text-align: center; }
h1 {
  font-size: 28px;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin: 0 0 12px 0;
}
.card {
  background: var(--glass);
  backdrop-filter: blur(6px);
  border-radius: 14px;
  padding: 16px 22px;
  box-shadow: 0 4px 30px rgba(0,0,0,0.3);
  margin-bottom: 20px;
}
.login {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  justify-content: center;
}
select, input[type="password"] {
  padding: 10px;
  border-radius: 8px;
  background: rgba(255,255,255,0.08);
  color: white;
  border: 1px solid rgba(255,255,255,0.1);
  cursor: pointer;
}
button.luminous {
  position: relative;
  background: linear-gradient(90deg, #dc2626, #16a34a, #f59e0b);
  background-size: 300% 100%;
  animation: buttonGlow 4s linear infinite;
  color: white;
  border: none;
  border-radius: 10px;
  padding: 12px 20px;
  font-weight: 600;
  letter-spacing: 0.5px;
  cursor: pointer;
  overflow: hidden;
  transition: transform 0.2s ease, box-shadow 0.3s ease;
}
button.luminous:hover {
  transform: scale(1.05);
  box-shadow: 0 0 25px rgba(124,58,237,0.4);
}
button.luminous:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
@keyframes buttonGlow {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
.roulette-container {
  margin-top: 30px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  position: relative;
}
.wheel-wrapper {
  position: relative;
  width: 360px;
  height: 360px;
}
.wheel {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  position: relative;
  overflow: hidden;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
  transform: rotate(0deg);
}
.segment-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform-origin: 0 0;
  font-size: 12px;
  font-weight: bold;
  color: white;
  text-shadow: 0 0 3px rgba(0,0,0,0.7);
  white-space: nowrap;
  pointer-events: none;
}
.indicator {
  width: 0;
  height: 0;
  border-left: 16px solid transparent;
  border-right: 16px solid transparent;
  border-bottom: 24px solid var(--accent);
  position: absolute;
  top: -12px;
  left: 50%;
  transform: translateX(-50%);
  filter: drop-shadow(0 0 6px var(--accent));
  z-index: 2;
}
.result {
  font-size: 20px;
  font-weight: 700;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.list {
  max-width: 360px;
  background: rgba(255,255,255,0.03);
  border-radius: 10px;
  padding: 10px;
  margin-top: 20px;
  max-height: 300px;
  overflow-y: auto;
}
.wheel.glow {
  box-shadow: 0 0 30px 10px rgba(250, 204, 21, 0.7);
  transition: box-shadow 0.6s ease-out;
}
.snow {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  overflow: hidden;
  z-index: 0;
}
.snowflake {
  position: absolute;
  top: -10px;
  color: white;
  font-size: 1em;
  opacity: 0.8;
  animation: fall linear infinite;
  user-select: none;
}
@keyframes fall {
  0% { transform: translateY(-10px) rotate(0deg); opacity: 0; }
  50% { opacity: 0.8; }
  100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
}
.person { display: flex; justify-content: space-between; padding: 6px 8px; border-bottom: 1px dashed rgba(255,255,255,0.05);}
.badge { padding: 4px 8px; border-radius: 999px; font-size: 12px; }
.badge.available { background: rgba(34,197,94,0.25); color: #bbf7d0; }
.badge.assigned { background: rgba(239,68,68,0.25); color: #fecaca; }
footer { margin-top: 40px; font-size: 13px; color: #9fb0c8; text-align: center; }
@media (max-width: 700px) {
  .wheel-wrapper { width: 280px; height: 280px; }
  .list { max-width: 90vw; }
}
</style>
</head>
<body>
<header>
  <h1>üéÅ Roulette de No√´l</h1>
  <div class="card login">
    <label>Nom :</label>
    <select id="loginSelect"></select>
    <input type="password" id="passwordInput" placeholder="Mot de passe" />
    <button id="loginBtn" class="luminous">Connexion</button>
  </div>
</header>

<main class="roulette-container">
  <div class="wheel-wrapper">
    <div class="indicator"></div>
    <div class="wheel" id="wheel"></div>
  </div>
  <button id="spinBtn" class="luminous">üé° Lancer la roulette</button>
  <div id="result" class="result">R√©sultat : ‚Äî</div>
  <div id="myStatus" class="card" style="min-width:280px;">Non connect√©</div>
  <div class="list" id="peopleList"></div>
</main>

<footer>
  ‚öôÔ∏è Connect√© √† Firestore : roulette-372ab
</footer>

<div class="snow" id="snow"></div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyASodoImTjzwF0rZuiQWdut3jtzYcQJ3cE",
  authDomain: "roulette-372ab.firebaseapp.com",
  projectId: "roulette-372ab",
  storageBucket: "roulette-372ab.firebasestorage.app",
  messagingSenderId: "689004074045",
  appId: "1:689004074045:web:ee74ce800d6590ea468654",
  measurementId: "G-ZH17Y9807B"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const loginSelect = document.getElementById('loginSelect');
const loginBtn = document.getElementById('loginBtn');
const passwordInput = document.getElementById('passwordInput');
const spinBtn = document.getElementById('spinBtn');
const peopleList = document.getElementById('peopleList');
const myStatus = document.getElementById('myStatus');
const result = document.getElementById('result');
const wheel = document.getElementById('wheel');

let currentUser = null;
let peopleCache = {};
let currentRotation = 0;

const peopleCol = collection(db, 'people');
onSnapshot(peopleCol, snap => {
  snap.docs.forEach(d => peopleCache[d.id] = d.data());
  renderUI();
  renderWheel();
});

function renderUI() {
  loginSelect.innerHTML = '';
  peopleList.innerHTML = '';
  const ids = Object.keys(peopleCache).sort();
  ids.forEach(id => {
    const opt = document.createElement('option');
    opt.value = id;
    opt.textContent = id;
    loginSelect.appendChild(opt);

    const p = peopleCache[id];
    const row = document.createElement('div');
    row.className = 'person';
    const badge = document.createElement('span');
    badge.className = 'badge ' + (p.assignedTo ? 'assigned' : 'available');
    badge.textContent = p.assignedTo ? (id === currentUser?.id ? 'Vous avez tir√© : ' + p.assignedTo : 'd√©j√† attribu√©') : 'disponible';
    row.innerHTML = `<div>${id}</div>`;
    row.appendChild(badge);
    peopleList.appendChild(row);
  });
  refreshMyStatus();
}

loginBtn.addEventListener('click', async () => {
  const id = loginSelect.value;
  const password = passwordInput.value.trim();
  if (!id) return alert('Choisissez un nom');
  if (!password) return alert('Entrez le mot de passe');

  const ref = doc(db, 'people', id);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    await setDoc(ref, { available: true, assignedTo: null, password: password });
    peopleCache[id] = { available: true, assignedTo: null, password: password };
    currentUser = { id };
    alert('Compte cr√©√© avec succ√®s !');
  } else {
    const data = snap.data();
    if (data.password === null) {
      await updateDoc(ref, { password: password });
      peopleCache[id].password = password;
      currentUser = { id };
      alert('Mot de passe enregistr√© avec succ√®s !');
    } else if (data.password !== password) {
      return alert('Mot de passe incorrect !');
    } else {
      currentUser = { id };
      alert('Connexion r√©ussie !');
    }
  }

  passwordInput.value = '';
  refreshMyStatus();
  renderWheel();
});

function refreshMyStatus() {
  if (!currentUser) {
    myStatus.textContent = 'Non connect√©';
    return;
  }
  const p = peopleCache[currentUser.id];
  if (!p) return;
  if (p.assignedTo) {
    myStatus.innerHTML = `üéÑ Connect√© en tant <b>${currentUser.id}</b><br>Vous avez tir√© : <b style="color:#4ade80">${p.assignedTo}</b>`;
    result.innerHTML = `R√©sultat : <span style="color:#4ade80;font-weight:700">${p.assignedTo}</span>`;
    spinBtn.disabled = true;
  } else {
    myStatus.innerHTML = `Connect√© : <b>${currentUser.id}</b><br>Pas encore de tirage.`;
    result.textContent = 'R√©sultat : ‚Äî';
    spinBtn.disabled = false;
  }
}

function renderWheel() {
  wheel.innerHTML = '';
  if (!currentUser) return;
  const entries = Object.entries(peopleCache).filter(([id]) => id !== currentUser.id);
  const count = entries.length;
  const gradientColors = [];
  entries.forEach(([id,p],i)=>{
    const start = (i*100/count).toFixed(2);
    const end = ((i+1)*100/count).toFixed(2);
    const hue = i*360/count;
    gradientColors.push(p.assignedTo ? `#555 ${start}% ${end}%` : `hsl(${hue},70%,50%) ${start}% ${end}%`);
  });
  wheel.style.background = `conic-gradient(${gradientColors.join(',')})`;

  entries.forEach(([id,p],i)=>{
    const angle = i * 360 / count + 360/(2*count);
    const txt = document.createElement('div');
    txt.className = 'segment-text';
    const radius = wheel.offsetWidth/2 - 30;
    txt.style.transform = `rotate(${angle}deg) translate(${radius}px) rotate(${-angle}deg)`;
    txt.textContent = id;
    wheel.appendChild(txt);
  });
}

spinBtn.addEventListener('click', async () => {
  if (!currentUser) return alert('Connectez-vous d\'abord');
  spinBtn.disabled = true;
  result.textContent = 'Roulette en cours... üé°';

  const pool = Object.entries(peopleCache)
    .filter(([id,p]) => !p.assignedTo && id!==currentUser.id)
    .map(([id])=>id);

  if(pool.length===0){ spinBtn.disabled=false; return alert('Personne disponible.'); }

  const picked = pool[Math.floor(Math.random()*pool.length)];
  const entries = Object.entries(peopleCache).filter(([id])=>id!==currentUser.id);
  const segmentCount = entries.length;
  const segmentAngle = 360 / segmentCount;
  const index = entries.findIndex(([id])=>id===picked);

  const targetAngle = 360 - (index * segmentAngle + segmentAngle / 2);
  const spins = 5 + 2;
  const finalRotation = currentRotation + spins*360 + targetAngle;
  currentRotation = finalRotation % 360;

  wheel.style.transition='transform 5s cubic-bezier(0.17,0.89,0.32,1.28)';
  wheel.style.transform=`rotate(${finalRotation}deg)`;

  setTimeout(()=>{ wheel.classList.add('glow'); setTimeout(()=>wheel.classList.remove('glow'),1500); },4900);

  setTimeout(async()=>{
    try{
      const targetRef=doc(db,'people',picked);
      const meRef=doc(db,'people',currentUser.id);
      await updateDoc(targetRef,{available:false,assignedTo:currentUser.id});
      await updateDoc(meRef,{assignedTo:picked});
      result.innerHTML=`R√©sultat : <span style="color:#4ade80;font-weight:700">${picked}</span>`;
      refreshMyStatus();
    }catch(e){console.error(e);alert('Erreur : '+e.message);} 
    finally{spinBtn.disabled=false;}
  },5200);
});

const snowContainer = document.getElementById('snow');
const flakeCount = 80;
for(let i=0;i<flakeCount;i++){
  const flake=document.createElement('div');
  flake.className='snowflake';
  flake.textContent='‚ùÑ';
  const size=Math.random()*10+8; flake.style.fontSize=`${size}px`;
  flake.style.left=`${Math.random()*100}%`;
  flake.style.animationDuration=`${Math.random()*10+5}s`;
  flake.style.opacity=Math.random()*0.5+0.5;
  flake.style.animationDelay=`${Math.random()*10}s`;
  snowContainer.appendChild(flake);
}
</script>
</body>
</html>
